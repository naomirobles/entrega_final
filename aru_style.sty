\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{aru_style}[2023/10/27 Estilo Aru Task Manager]

% ==================== 1. CODIFICACIÓN Y LENGUAJE ====================
\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage[spanish, es-tabla]{babel} % es-tabla para que diga "Tabla" y no "Cuadro"

% ==================== 2. DISEÑO DE PÁGINA Y FORMATO ====================
\RequirePackage{geometry}
\geometry{top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm}
\RequirePackage{setspace}
\onehalfspacing
\RequirePackage{fancyhdr}
\RequirePackage{titlesec}
\RequirePackage{pdflscape} % Para páginas en horizontal
\RequirePackage{anysize}   % Nota: geometry ya hace esto, pero lo mantengo si lo prefieres
\RequirePackage{textcase}
\usepackage{afterpage}

% ==================== 3. GRÁFICOS Y COLORES ====================
\RequirePackage{graphicx}
\RequirePackage{xcolor} % Soporta [table, xcdraw] si se requiere
\RequirePackage{tikz}
\RequirePackage{pgfgantt}
\RequirePackage{float}
\RequirePackage[most]{tcolorbox}
\RequirePackage{fontawesome5}


% ==================== 4. MATEMÁTICAS Y CIENCIA ====================
\RequirePackage{amsmath, amssymb, amsthm, amsfonts}
\RequirePackage{commath}
\RequirePackage{cancel}
\RequirePackage{siunitx}
\RequirePackage{latexsym}

% ==================== 5. TABLAS Y LISTAS ====================
\RequirePackage{booktabs}
\RequirePackage{multirow}
\RequirePackage{array}
\RequirePackage{longtable}
\RequirePackage{enumitem}
\usepackage{tabularray}
\usepackage{tabularx}
\usepackage{colortbl}

% ==================== 6. CAPTIONS Y FIGURAS ====================
\RequirePackage{caption}
\RequirePackage{subcaption} % Reemplaza al antiguo subfigure
\RequirePackage{sidecap}
\RequirePackage{capt-of}
\sidecaptionvpos{figure}{c}

% ==================== 7. CÓDIGO Y ALGORITMOS ====================
\RequirePackage{listings}
\RequirePackage{listingsutf8}
\RequirePackage{algorithm}
\RequirePackage{algpseudocode}
\RequirePackage{upquote}
\RequirePackage{textcomp}

% ==================== 8. BIBLIOGRAFÍA Y APÉNDICES ====================
\RequirePackage[backend=biber, style=ieee, sorting=none]{biblatex}
\RequirePackage[title, titletoc]{appendix}
\renewcommand{\appendixname}{Apéndices}

% ==================== 9. HIPERVÍNCULOS (SIEMPRE AL FINAL) ====================
\RequirePackage{url}
\RequirePackage[colorlinks=true, plainpages=true, citecolor=blue, linkcolor=black]{hyperref}

% ==================== CONFIGURACIÓN ADICIONAL ====================
\pagestyle{fancy}
\fancyhf{}
\fancyhead[L]{\footnotesize Ingeniería de Software para Sistemas Inteligentes}
\fancyfoot[C]{\thepage}
\renewcommand{\footrulewidth}{0.4pt}
\renewcommand{\familydefault}{\sfdefault} % Usar Helvetica (similar a la imagen)
\definecolor{dkgreen}{rgb}{0,0.6,0} 
\definecolor{gray}{rgb}{0.5,0.5,0.5} 
\definecolor{verde}{rgb}{0.18,0.549,0.2}
\definecolor{rojo}{rgb}{1, 0.302, 0.431}
\definecolor{black}{rgb}{0, 0, 0}
\definecolor{blue}{rgb}{0, 0.4648, 0.71}
\definecolor{charcoal}{RGB}{54,69,79}

\definecolor{aruPurple}{HTML}{9381DA}
\definecolor{aruBg}{HTML}{F8F9FE}
\definecolor{aruText}{HTML}{4A4A4A}
\definecolor{pastelPink}{HTML}{FDE7F9}
\definecolor{pastelBlue}{HTML}{E7F3FD}

\definecolor{catCalculo}{HTML}{FDE7E7}
\definecolor{catHistoria}{HTML}{E7FDF3}
\definecolor{catEconomia}{HTML}{FFF4E5}
\definecolor{catIngles}{HTML}{FDE7F9}

\definecolor{codegreen}{rgb}{0,0.6,0}          % Verde para comentarios
\definecolor{codegray}{rgb}{0.5,0.5,0.5}       % Gris para números de línea
\definecolor{codepurple}{rgb}{0.58,0,0.82}     % Púrpura para strings
\definecolor{backcolour}{rgb}{0.98,0.98,0.99}  % Color de fondo
\definecolor{keywordcolor}{rgb}{0,0.59,0.61}   % Color para palabras clave (class, def, etc.)
\definecolor{titlecolor}{rgb}{0.53,0,0}        % Color para títulos de clases y funciones
\definecolor{stringcolor}{rgb}{0,0.36,0.37}    % Color para strings
\definecolor{commentcolor}{rgb}{0.58,0.65,0.65} % Color para comentarios

% Definir el estilo para el código
\lstdefinestyle{mystyle}{
    backgroundcolor=\color{backcolour},   
    commentstyle=\color{commentcolor},
    keywordstyle=\color{keywordcolor},
    numberstyle=\tiny\color{codegray},
    stringstyle=\color{stringcolor},
    basicstyle=\ttfamily\footnotesize,
    breakatwhitespace=false,         
    breaklines=true,                 
    captionpos=b,                    
    keepspaces=true,                 
    numbers=left,                    
    numbersep=5pt,                  
    showspaces=false,                
    showstringspaces=false,
    showtabs=false,                  
    tabsize=2,
    emph={class,def,__init__,return,import}, % Palabras clave adicionales
    emphstyle=\color{titlecolor},            % Estilo para palabras clave adicionales
    morekeywords={class,def,__init__,return,import}, % Añadir palabras clave
     % ahora añadimos los símbolos faltantes
}

\lstset{style=mystyle}

\makeatletter
\renewcommand{\section}[1]{%
  \refstepcounter{section}%
  \par\bigskip
  \noindent
  \begin{tcolorbox}[
    colback=aruPurple,
    colframe=aruPurple,
    arc=10pt,
    sharp corners=north,
    boxrule=0pt,
    left=15pt,
    right=15pt,
    top=12pt,
    bottom=12pt,
    width=\linewidth
  ]
    {\color{white}\Large\bfseries\sffamily
      \faListUL\quad\thesection.\quad #1
    }
  \end{tcolorbox}
  \par\medskip
}
\makeatother


% --- Subsecciones con número (ej: 1.1 aru:taskmanager) ---
\titleformat{\subsection}
  {\color{aruPurple}\sffamily\Large\bfseries} % Formato general
  {\thesubsection} % Aquí incluimos el número de la subsección
  {1em} % Espacio entre el número y el texto
  {} % Aplicamos minúsculas solo al título
  []

% --- Subsubsecciones con número (ej: 1.1.1 módulos) ---
\titleformat{\subsubsection}
  {\color{aruPurple!80}\sffamily\large\bfseries}
  {\thesubsubsection}
  {1em}
  {}
  []

% Re-ajuste de espaciado para acomodar los números
\titlespacing*{\subsection}{0pt}{3.5ex plus 1ex minus .2ex}{1.5ex plus .2ex}
\titlespacing*{\subsubsection}{0pt}{2.5ex plus 1ex minus .2ex}{1.2ex plus .2ex}


% --- Configuración de Título Estilo Banner ---
\newcommand{\makeAruHeader}[1]{
    \begin{tcolorbox}[colback=aruPurple, colframe=aruPurple, arc=10pt, sharp corners=north, 
                      top=15pt, bottom=15pt, left=20pt]
        \textcolor{white}{\Large\bfseries \faListUL \quad #1}
        \hfill
        \textcolor{white!80}{\small }
    \end{tcolorbox}
}



% --- Entorno para las "Secciones" (Columnas de Materias) ---
\newtcolorbox{aruSeccion}[2]{
    enhanced,
    title={\large\bfseries #1},
    coltitle=aruText,
    attach boxed title to top left={xshift=5mm, yshift=-3mm},
    boxed title style={colback=white, colframe=white, arc=5pt},
    colback=#2,
    colframe=white,
    arc=15pt,
    width=0.98\textwidth,
    nobeforeafter,
    bottom=10pt,
    top=10pt
}

% --- Entorno para las "Tareas" (Tarjetas blancas internas) ---
\newtcolorbox{aruTarea}[2]{
    enhanced,
    colback=white,
    colframe=white,
    arc=8pt,
    boxrule=0pt,
    shadow={2pt}{-2pt}{0pt}{black!5}, % Sombra suave
    title={\small\bfseries #1},
    coltitle=black,
    attach title to top left={yshift=-2mm},
    fonttitle=\bfseries,
    after title={\hfill \faRegCircle}, % Círculo de checkbox
    fontupper=\scriptsize,
    top=8mm
}
% Definición del entorno corregido
\newtcolorbox{tablaAru}{
    enhanced,
    arc=6pt,                         % Bordes redondeados
    colframe=aruPurple,              % Color del borde exterior
    colback=white,                   % Fondo de la caja
    boxrule=1pt,                     % Grosor del borde
    clip upper,                      % Corta el contenido para que respete la curva
    left=0pt, right=0pt, top=0pt, bottom=0pt, % Eliminar márgenes internos de la caja
    boxsep=0pt,
    tabularx={
        >{\columncolor{aruPurple}\color{white}\bfseries\centering}p{3.5cm} % Columna púrpura
        >{\color{aruText}\raggedright\arraybackslash}X                   % Columna contenido
    }
}

% =========================================================================
% CONFIGURACIÓN DE ESTILO PARA TABLAS MODERNAS (ARU STYLE)
% =========================================================================

% Comandos para el cebreado (intercalado de filas)
\newcommand{\filaGris}{\rowcolor{aruBg}}
\newcommand{\filaBlanca}{\rowcolor{white}}
\newcommand{\seccionTabla}[1]{\rowcolor{aruPurple!20}\multicolumn{2}{|c|}{\textbf{\color{aruText}#1}} \\}

% 1. Entorno para REQUISITOS (2 columnas: Clave y Descripción)
\newtcolorbox{tablaRequisitos}[1]{
    enhanced, 
    arc=8pt, 
    colframe=aruPurple, 
    colback=white, 
    boxrule=1.2pt, 
    clip upper,
    boxsep=0pt, left=0pt, right=0pt, top=0pt, bottom=0pt,
    fonttitle=\bfseries,
    title=#1,
    tabularx={
        >{\columncolor{aruPurple}\color{black}\bfseries\centering}p{2.5cm} 
        >{\color{aruText}\raggedright\arraybackslash}X
    }
}

% 2. Entorno para HISTORIAS DE USUARIO (Cabecera lateral más ancha)
\newtcolorbox{tablaHistoria}[1]{
    enhanced, 
    arc=8pt, 
    colframe=aruPurple, 
    colback=white, 
    boxrule=1.2pt, 
    clip upper,
    boxsep=0pt, left=0pt, right=0pt, top=0pt, bottom=0pt,
    fonttitle=\bfseries,
    title=#1,
    tabularx={
        >{\columncolor{aruPurple}\color{black}\bfseries\centering}p{3.8cm} 
        >{\color{aruText}\raggedright\arraybackslash}X
    }
}